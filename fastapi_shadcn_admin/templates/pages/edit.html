{% extends "layouts/base.html" %}
{% import "components/buttons.html" as buttons %}
{% import "components/cards.html" as cards %}
{% import "components/inputs.html" as inputs %}

{% block title %}{% if record_id %}Edit{% else %}Create{% endif %} {{ model_config.name }}{% endblock %}

{% block breadcrumb %}
<nav class="flex items-center space-x-2 text-sm text-muted-foreground">
    <a href="{{ url_for('admin:index') }}" class="hover:text-foreground">Dashboard</a>
    <span>/</span>
    <a href="{{ url_for('admin:list', model=model_config.name) }}" class="hover:text-foreground">{{ model_config.name
        }}</a>
    <span>/</span>
    <span class="text-foreground">{% if record_id %}Edit{% else %}Create{% endif %}</span>
</nav>
{% endblock %}

{% block content %}
<div class="max-w-2xl space-y-6">
    <!-- Header -->
    <div>
        <h1 class="text-3xl font-bold tracking-tight text-foreground">
            {% if record_id %}Edit {{ model_config.name }}{% else %}Create {{ model_config.name }}{% endif %}
        </h1>
        <p class="text-muted-foreground">
            {% if record_id %}Update the record details below{% else %}Fill in the details to create a new record{%
            endif %}
        </p>
    </div>

    <!-- Error Summary -->
    {{ inputs.error_summary(errors.get('__all__', [])) }}

    <!-- Form -->
    {% call cards.card() %}
    {% call cards.card_content() %}
    <form method="POST"
        action="{% if record_id %}{{ url_for('admin:update', model=model_config.name, id=record_id) }}{% else %}{{ url_for('admin:create_submit', model=model_config.name) }}{% endif %}"
        class="space-y-6" hx-boost="true" hx-indicator=".htmx-indicator">
        <!-- CSRF Token -->
        <input type="hidden" name="_csrf_token" value="{{ csrf_token }}" />

        <!-- Form Fields -->
        <div class="space-y-4">
            {% for field in fields %}
            <div class="space-y-2">
                {% if field.field_type.value == "text" %}
                {% call inputs.form_field(field.name, field.title, field.required, error=errors.get(field.name),
                description=field.description) %}
                {{ inputs.input(field.name, type="text", value=values.get(field.name, field.default or ''),
                placeholder=field.placeholder or '', required=field.required, readonly=field.readonly) }}
                {% endcall %}

                {% elif field.field_type.value == "textarea" %}
                {% call inputs.form_field(field.name, field.title, field.required, error=errors.get(field.name),
                description=field.description) %}
                {{ inputs.textarea(field.name, value=values.get(field.name, field.default or ''),
                placeholder=field.placeholder or '', required=field.required) }}
                {% endcall %}

                {% elif field.field_type.value == "number" %}
                {% call inputs.form_field(field.name, field.title, field.required, error=errors.get(field.name),
                description=field.description) %}
                {{ inputs.number_input(field.name, value=values.get(field.name, field.default or ''),
                min=field.min_value, max=field.max_value, required=field.required) }}
                {% endcall %}

                {% elif field.field_type.value == "float" %}
                {% call inputs.form_field(field.name, field.title, field.required, error=errors.get(field.name),
                description=field.description) %}
                {{ inputs.number_input(field.name, value=values.get(field.name, field.default or ''), step="0.01",
                required=field.required) }}
                {% endcall %}

                {% elif field.field_type.value == "boolean" %}
                {{ inputs.checkbox(field.name, field.title, checked=values.get(field.name, field.default or false)) }}

                {% elif field.field_type.value == "select" %}
                {% call inputs.form_field(field.name, field.title, field.required, error=errors.get(field.name),
                description=field.description) %}
                {{ inputs.select(field.name, field.options, value=values.get(field.name, field.default or ''),
                required=field.required) }}
                {% endcall %}

                {% elif field.field_type.value == "union" %}
                {# Discriminated union - polymorphic form #}
                {% call inputs.form_field(field.discriminator, field.title, field.required, description="Select the
                type") %}
                <select id="{{ field.discriminator }}" name="{{ field.discriminator }}"
                    class="flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"
                    hx-get="{{ fragment_url }}" hx-target="#polymorphic-fields-{{ field.name }}" hx-swap="innerHTML"
                    hx-trigger="change" hx-include="[name='_model']" hx-indicator=".htmx-indicator" {% if field.required
                    %}required{% endif %}>
                    <option value="" disabled {% if not values.get(field.discriminator) %}selected{% endif %}>Select
                        type...</option>
                    {% for val in field.discriminator_values %}
                    <option value="{{ val }}" {% if values.get(field.discriminator)==val %}selected{% endif %}>{{ val }}
                    </option>
                    {% endfor %}
                </select>
                <input type="hidden" name="_model" value="{{ model_config.name }}" />
                {% endcall %}

                {# Container for dynamically loaded fields #}
                <div id="polymorphic-fields-{{ field.name }}" class="mt-4 space-y-4">
                    {% if values.get(field.discriminator) %}
                    {# Load initial subtype fields if editing #}
                    {% include "fragments/form_fields.html" %}
                    {% endif %}
                </div>

                {% elif field.field_type.value == "email" %}
                {% call inputs.form_field(field.name, field.title, field.required, error=errors.get(field.name),
                description=field.description) %}
                {{ inputs.input(field.name, type="email", value=values.get(field.name, field.default or ''),
                placeholder="email@example.com", required=field.required) }}
                {% endcall %}

                {% elif field.field_type.value == "url" %}
                {% call inputs.form_field(field.name, field.title, field.required, error=errors.get(field.name),
                description=field.description) %}
                {{ inputs.input(field.name, type="url", value=values.get(field.name, field.default or ''),
                placeholder="https://...", required=field.required) }}
                {% endcall %}

                {% elif field.field_type.value == "nested" %}
                <fieldset class="space-y-4 rounded-lg border border-border p-4">
                    <legend class="px-2 text-sm font-medium text-foreground">{{ field.title }}</legend>
                    {% for child in field.children %}
                    {# Recursive child rendering with prefixed names #}
                    {% set child_name = field.name ~ "." ~ child.name %}
                    {% call inputs.form_field(child_name, child.title, child.required) %}
                    {{ inputs.input(child_name, value=values.get(child_name, child.default or ''),
                    required=child.required) }}
                    {% endcall %}
                    {% endfor %}
                </fieldset>

                {% elif field.field_type.value == "complex" %}
                <div class="rounded-lg border border-border bg-muted/50 p-4">
                    <p class="text-sm text-muted-foreground">
                        <svg class="inline-block h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        {{ field.description or 'Complex object - edit as JSON' }}
                    </p>
                    {{ inputs.textarea(field.name, value=values.get(field.name, '{}'), rows=5) }}
                </div>

                {% else %}
                {# Fallback #}
                {% call inputs.form_field(field.name, field.title, field.required) %}
                {{ inputs.input(field.name, value=values.get(field.name, field.default or ''), required=field.required)
                }}
                {% endcall %}
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- Actions -->
        <div class="flex items-center justify-between pt-4 border-t border-border">
            {{ buttons.link_button(url_for('admin:list', model=model_config.name), "Cancel", variant="outline") }}

            <div class="flex items-center space-x-2">
                {% if record_id and not model_config.readonly %}
                <button type="button"
                    class="inline-flex items-center justify-center rounded-md text-sm font-medium h-10 px-4 py-2 bg-destructive text-destructive-foreground hover:bg-destructive/90"
                    hx-delete="{{ url_for('admin:delete', model=model_config.name, id=record_id) }}"
                    hx-confirm="Are you sure you want to delete this record?" hx-target="body">
                    Delete
                </button>
                {% endif %}

                {% if not model_config.readonly %}
                {{ buttons.submit_button("Save", variant="default") }}
                {% endif %}
            </div>
        </div>
    </form>
    {% endcall %}
    {% endcall %}
</div>
{% endblock %}